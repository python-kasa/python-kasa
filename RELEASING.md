## Set release information

```bash
# export PREVIOUS_RELEASE=$(git describe --abbrev=0)
export PREVIOUS_RELEASE=0.3.5 # generate the full changelog since last pyhs100 release
export NEW_RELEASE=0.4.0.dev4
```

## Update the version number

```bash
poetry version $NEW_RELEASE
```

## Update dependencies and run tests

```bash

poetry update
pre-commit run --all-files && pytest kasa
```

## Write a short and understandable summary for the release.

This step is only needed, if you want to include a summary text in the autogenerated changelog.

* Create a new issue and label it with release-summary
* Create $NEW_RELEASE milestone in github, and assign the issue to that
* Close the issue

3. Generate changelog

```bash
# gem install github_changelog_generator --pre
# https://github.com/github-changelog-generator/github-changelog-generator#github-token
export CHANGELOG_GITHUB_TOKEN=token
github_changelog_generator --base HISTORY.md --user python-kasa --project python-kasa --since-tag $PREVIOUS_RELEASE --future-release $NEW_RELEASE -o CHANGELOG.md


#-exclude-tags-regex 'dev\d$'
```

Remove '--exclude-tags-regex' for dev releases.
TODO: Find a nice way to collate dev* changes to real releases. Excluding them causes them to re-appear for pre-releases, but maybe that's fine?

## Commit the changed files

```bash
git commit --all --verbose
```

## Create a PR for the release, merge it, and re-fetch the master

```bash
git checkout master
git fetch upstream
git rebase upstream/master
```

## Create a release tag

Note, add changelog as the tag commit message so `gh release create --notes-from-tag` can be used to create a release draft.

```bash
git tag --annotate $NEW_RELEASE
git push upstream $NEW_RELEASE
```


## Create release using 'gh release create'

### Pre-releases

```bash
gh release create $NEW_VERSION --verify-tag --latest=false --notes-from-tag --prerelease --draft
```

### Release

```bash
gh release create $NEW_VERSION --verify-tag --latest=true --notes-from-tag --draft
```


## Manual releasing

Go to the linked URL, verify the contents, and click "release" button to trigger the release CI.
